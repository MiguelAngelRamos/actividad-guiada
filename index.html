<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taller Selenium: Automatización de Registro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome para iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js para el gráfico de progreso -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Estilos personalizados para scroll y código */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .code-preview { background-color: #1e293b; color: #e2e8f0; font-family: 'Consolas', 'Monaco', monospace; }
        .keyword { color: #c678dd; } /* Púrpura */
        .string { color: #98c379; }  /* Verde */
        .comment { color: #5c6370; font-style: italic; } /* Gris */
        .function { color: #61afef; } /* Azul */
        
        .chart-container { position: relative; height: 200px; width: 200px; margin: 0 auto; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 h-screen flex overflow-hidden text-slate-800">

    <!-- Sidebar de Navegación -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 z-20 shadow-lg">
        <div class="p-6 bg-indigo-600 text-white">
            <h1 class="text-xl font-bold"><i class="fas fa-robot mr-2"></i>Selenium BDD</h1>
            <p class="text-indigo-200 text-xs mt-1">Módulo: Registro de Usuarios</p>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-1" id="nav-container">
            <!-- Los botones de navegación se generan dinámicamente -->
        </nav>

        <div class="p-4 bg-slate-50 border-t border-slate-200">
            <div class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                <span>PROGRESO</span>
                <span id="progress-text">0%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2">
                <div id="progress-bar" class="bg-indigo-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
    </aside>

    <!-- Área Principal de Contenido -->
    <main class="flex-1 overflow-y-auto relative bg-slate-50">
        <div class="max-w-5xl mx-auto p-8" id="content-area">
            <!-- El contenido dinámico se carga aquí -->
        </div>
    </main>

    <!-- JAVASCRIPT: Lógica de la Aplicación -->
    <script>
        // --- DATOS DEL TALLER ---
        const workshopData = {
            intro: {
                id: 'intro',
                title: 'Bienvenido al Taller',
                icon: 'fa-home',
                content: `
                    <div class="text-center mb-10 fade-in">
                        <h1 class="text-4xl font-bold text-slate-800 mb-4">Automatización del Registro</h1>
                        <p class="text-lg text-slate-600 max-w-2xl mx-auto">
                            En esta actividad guiada, expandirás el framework de pruebas existente para cubrir una funcionalidad crítica: 
                            <strong>El Registro de Nuevos Usuarios</strong>.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 fade-in">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="text-lg font-bold text-indigo-600 mb-4"><i class="fas fa-bullseye mr-2"></i>Objetivos</h3>
                            <ul class="space-y-3 text-slate-600">
                                <li class="flex items-start"><i class="fas fa-check text-emerald-500 mt-1 mr-2"></i> Crear archivos Gherkin (.feature).</li>
                                <li class="flex items-start"><i class="fas fa-check text-emerald-500 mt-1 mr-2"></i> Implementar Page Objects (.py).</li>
                                <li class="flex items-start"><i class="fas fa-check text-emerald-500 mt-1 mr-2"></i> Refactorizar pasos comunes.</li>
                                <li class="flex items-start"><i class="fas fa-check text-emerald-500 mt-1 mr-2"></i> Manejar localStorage del navegador.</li>
                            </ul>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center">
                            <div class="chart-container">
                                <canvas id="progressChart"></canvas>
                            </div>
                            <button onclick="app.loadStep(0)" class="mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full transition-colors shadow-md shadow-indigo-200">
                                Comenzar <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                `
            },
            steps: [
                {
                    title: "Paso 1: Entorno",
                    subtitle: "Limpieza Profunda",
                    desc: "La web guarda usuarios en localStorage. Debemos limpiarlo antes de cada test para evitar falsos positivos.",
                    file: "conftest.py",
                    code: `@pytest.fixture(autouse=True)
def reset_between_test(selenium, base_url):
    selenium.delete_all_cookies()
    selenium.get(f"{base_url}/index.html")
    
    # --- NUEVO CÓDIGO ---
    # Limpiamos localStorage para asegurar un estado limpio
    selenium.execute_script("window.localStorage.clear();")
    # --------------------
    
    yield`,
                    analysis: "<strong>Por qué es crítico:</strong> Si ejecutas el test dos veces, la segunda vez fallará porque el usuario ya existe en el navegador. <code>selenium.execute_script</code> nos permite ejecutar JS nativo para limpiar la base de datos local."
                },
                {
                    title: "Paso 2: BDD",
                    subtitle: "Definición del Comportamiento",
                    desc: "Creamos un nuevo archivo Gherkin para describir los escenarios de éxito y error.",
                    file: "features/register_user.feature",
                    code: `@registro
Feature: Registro de Usuarios
  Como nuevo visitante
  Quiero crear una cuenta
  Para poder acceder a las ofertas exclusivas

  Background:
    Given que estoy en la página de inicio

  Scenario: Registro de usuario exitoso
    Given que navego al formulario de registro
    When completo el registro con usuario "estudiante_pro" y pass "123456"
    Then debería ver una alerta de éxito con el texto "Registro exitoso"

  Scenario: Intento de registro con usuario existente
    Given que navego al formulario de registro
    When completo el registro con usuario "test" y pass "test"
    And debería ver una alerta de éxito con el texto "Registro exitoso"
    And navego al formulario de registro
    And completo el registro con usuario "test" y pass "test"
    Then debería ver una alerta de error con el texto "El usuario ya existe"`,
                    analysis: "<strong>Estrategia:</strong> Usamos el tag <code>@registro</code>. Nota cómo en el segundo escenario, primero creamos el usuario exitosamente y luego intentamos crearlo de nuevo para forzar el error."
                },
                {
                    title: "Paso 3: Configuración",
                    subtitle: "Registro de Markers",
                    desc: "Registramos el tag @registro para evitar warnings y poder filtrar la ejecución.",
                    file: "pytest.ini",
                    code: `[pytest]
# ... configuraciones previas ...

# Markers
markers =
    registro: Pruebas de registro`,
                    analysis: "Esto permite ejecutar en la terminal: <code>python -m pytest -m registro</code> y correr solo estos tests nuevos."
                },
                {
                    title: "Paso 4: Page Object",
                    subtitle: "Abstracción (POM)",
                    desc: "Creamos la clase que encapsula los selectores y acciones de la página de registro.",
                    file: "pages/register_page.py",
                    code: `from selenium.webdriver.common.by import By
from pages.base_page import BasePage

class RegisterPage(BasePage):
    # --- LOCALIZADORES ---
    LINK_TO_REGISTER = (By.ID, "link-to-register")
    USERNAME_INPUT = (By.ID, "reg-username")
    PASSWORD_INPUT = (By.ID, "reg-password")
    REGISTER_BTN = (By.ID, "btn-register")

    # --- ACCIONES ---

    def go_to_register(self):
        """Cambia la vista al formulario"""
        self.find_clickable(*self.LINK_TO_REGISTER).click()

    def register_user(self, username, password):
        """Llena el formulario"""
        # Limpiamos y escribimos
        self.find_element(*self.USERNAME_INPUT).send_keys(username)
        self.find_element(*self.PASSWORD_INPUT).send_keys(password)
        
        # Click
        self.find_clickable(*self.REGISTER_BTN).click()`,
                    analysis: "<strong>Buenas Prácticas:</strong> Separamos los IDs de la lógica. Si el ID cambia en el HTML, solo lo actualizamos aquí, no en los tests."
                },
                {
                    title: "Paso 5: Refactor",
                    subtitle: "Código Común",
                    desc: "Movemos el paso de 'ir al home' a un archivo compartido para evitar duplicidad.",
                    file: "steps/common_steps.py",
                    code: `from pytest_bdd import given

@given("que estoy en la página de inicio")
def go_to_homepage(selenium):
    """
    Paso inicial compartido. El navegador ya está en el index gracias
    al fixture 'reset_between_test' en conftest.py.
    """
    pass`,
                    analysis: "<strong>Arquitectura:</strong> Antes este paso estaba en <code>store_steps.py</code>. Al necesitarlo ahora en <code>register_steps.py</code>, moverlo a <code>common_steps.py</code> evita dependencias circulares."
                },
                {
                    title: "Paso 6: Steps",
                    subtitle: "Implementación Lógica",
                    desc: "Conectamos Gherkin con Python. Usamos timestamps para usuarios únicos.",
                    file: "steps/register_steps.py",
                    code: `from pytest_bdd import scenario, given, when, then, parsers
from pages.register_page import RegisterPage
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
import time

# ... Scenarios omitidos por brevedad ...

@when(parsers.parse('completo el registro con usuario "{user}" y pass "{password}"'))
def complete_registration(selenium, user, password):
    page = RegisterPage(selenium, "")
    
    # Lógica para garantizar unicidad
    if user == "test":
        unique_user = "test"
    else:
        # Agregamos timestamp: usuario_17089123
        unique_user = f"{user}_{int(time.time())}"

    page.register_user(unique_user, password)

@then(parsers.parse('debería ver una alerta de éxito con el texto "{texto_esperado}"'))
def verify_success_alert(selenium, texto_esperado):
    # Manejo de Alerta Nativa
    WebDriverWait(selenium, 5).until(EC.alert_is_present())
    alert = selenium.switch_to.alert
    assert texto_esperado in alert.text
    alert.accept()`,
                    analysis: "<strong>Idempotencia:</strong> El uso de <code>time.time()</code> garantiza que cada ejecución use un usuario nuevo, evitando fallos por duplicados en el test de éxito."
                }
            ]
        };

        // --- LÓGICA DEL APP ---
        const app = {
            currentState: 'intro', // 'intro' o index numérico
            completedSteps: new Set(),
            chart: null,

            init() {
                this.renderNav();
                this.loadContent('intro');
                this.initChart();
            },

            // Renderiza la barra lateral
            renderNav() {
                const container = document.getElementById('nav-container');
                container.innerHTML = `
                    <button onclick="app.loadContent('intro')" class="w-full text-left px-4 py-3 rounded-lg mb-2 flex items-center transition-colors ${this.currentState === 'intro' ? 'bg-indigo-50 text-indigo-700 font-bold' : 'text-slate-600 hover:bg-slate-50'}">
                        <i class="fas fa-home w-6 text-center mr-2"></i> Inicio
                    </button>
                    <div class="border-t border-slate-100 my-2"></div>
                `;

                workshopData.steps.forEach((step, index) => {
                    const isCompleted = this.completedSteps.has(index);
                    const isActive = this.currentState === index;
                    
                    let btnClass = "w-full text-left px-4 py-3 rounded-lg mb-1 flex items-center justify-between transition-colors ";
                    if (isActive) btnClass += "bg-indigo-50 text-indigo-700 font-bold ring-1 ring-indigo-200";
                    else btnClass += "text-slate-600 hover:bg-slate-50";

                    container.innerHTML += `
                        <button onclick="app.loadStep(${index})" class="${btnClass}">
                            <div class="flex items-center">
                                <span class="w-6 text-center mr-2 text-xs font-bold ${isActive ? 'text-indigo-500' : 'text-slate-400'}">${index + 1}</span>
                                <span class="text-sm truncate">${step.title}</span>
                            </div>
                            ${isCompleted ? '<i class="fas fa-check-circle text-emerald-500 text-xs"></i>' : ''}
                        </button>
                    `;
                });
            },

            // Carga Intro o Pasos
            loadContent(type) {
                this.currentState = type;
                this.renderNav();
                const container = document.getElementById('content-area');
                
                if (type === 'intro') {
                    container.innerHTML = workshopData.intro.content;
                    // Pequeño timeout para que el canvas exista antes de pintar el chart
                    setTimeout(() => {
                        this.initChart(); // Reiniciar chart en intro
                        this.updateChart();
                    }, 50);
                }
            },

            loadStep(index) {
                this.currentState = index;
                this.renderNav();
                const step = workshopData.steps[index];
                const container = document.getElementById('content-area');
                const isLast = index === workshopData.steps.length - 1;

                // Formateo simple de sintaxis
                const prettyCode = this.syntaxHighlight(step.code);

                container.innerHTML = `
                    <div class="fade-in">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-xs font-bold text-indigo-500 uppercase tracking-wide mb-1">${step.title}</h2>
                                <h1 class="text-3xl font-bold text-slate-800">${step.subtitle}</h1>
                            </div>
                            <button onclick="app.toggleComplete(${index})" class="flex items-center px-4 py-2 rounded-lg border transition-all ${this.completedSteps.has(index) ? 'bg-emerald-100 border-emerald-200 text-emerald-700' : 'bg-white border-slate-300 text-slate-500 hover:bg-slate-50'}">
                                <i class="fas ${this.completedSteps.has(index) ? 'fa-check-circle' : 'fa-circle'} mr-2"></i>
                                ${this.completedSteps.has(index) ? 'Completado' : 'Marcar como Hecho'}
                            </button>
                        </div>

                        <p class="text-slate-600 mb-6 text-lg border-l-4 border-indigo-400 pl-4 bg-white py-2 rounded-r shadow-sm">
                            ${step.desc}
                        </p>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                            <div class="lg:col-span-2">
                                <div class="bg-slate-800 rounded-t-lg px-4 py-2 flex justify-between items-center">
                                    <span class="text-slate-400 text-xs font-mono"><i class="fas fa-file-code mr-2"></i>${step.file}</span>
                                    <button onclick="app.copyToClipboard(this)" class="text-slate-400 hover:text-white text-xs"><i class="far fa-copy"></i> Copiar</button>
                                </div>
                                <pre class="code-preview p-4 overflow-x-auto rounded-b-lg shadow-lg text-sm leading-relaxed"><code>${prettyCode}</code></pre>
                            </div>

                            <div class="lg:col-span-1 space-y-4">
                                <div class="bg-amber-50 border border-amber-200 rounded-lg p-5 shadow-sm">
                                    <h3 class="font-bold text-amber-800 mb-2 flex items-center"><i class="fas fa-lightbulb mr-2"></i> Insight Técnico</h3>
                                    <div class="text-sm text-amber-900 leading-relaxed">
                                        ${step.analysis}
                                    </div>
                                </div>
                                <div class="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
                                    <h3 class="font-bold text-slate-700 mb-2 text-sm">Acciones</h3>
                                    <ul class="text-sm text-slate-600 space-y-2">
                                        <li><i class="fas fa-angle-right text-indigo-500 mr-2"></i>Abrir <code>${step.file}</code></li>
                                        <li><i class="fas fa-angle-right text-indigo-500 mr-2"></i>Pegar el código</li>
                                        <li><i class="fas fa-angle-right text-indigo-500 mr-2"></i>Guardar cambios</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between mt-8 pt-6 border-t border-slate-200">
                            <button onclick="app.loadStep(${index - 1})" ${index === 0 ? 'disabled class="opacity-0"' : ''} class="text-slate-500 hover:text-indigo-600 font-medium">
                                <i class="fas fa-arrow-left mr-2"></i> Anterior
                            </button>
                            ${isLast ? 
                                `<button onclick="alert('¡Felicidades! Has completado el taller. Ejecuta: python -m pytest -m registro -v')" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-lg shadow-md shadow-emerald-200 transition-colors">
                                    Finalizar Taller <i class="fas fa-flag-checkered ml-2"></i>
                                </button>` : 
                                `<button onclick="app.loadStep(${index + 1})" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md shadow-indigo-200 transition-colors">
                                    Siguiente Paso <i class="fas fa-arrow-right ml-2"></i>
                                </button>`
                            }
                        </div>
                    </div>
                `;
            },

            // Utilidades
            toggleComplete(index) {
                if (this.completedSteps.has(index)) {
                    this.completedSteps.delete(index);
                } else {
                    this.completedSteps.add(index);
                }
                this.loadStep(index); // Re-render para actualizar botón
                this.updateProgress();
            },

            updateProgress() {
                const total = workshopData.steps.length;
                const done = this.completedSteps.size;
                const percent = Math.round((done / total) * 100);
                
                document.getElementById('progress-bar').style.width = `${percent}%`;
                document.getElementById('progress-text').innerText = `${percent}%`;
                
                this.updateChart();
            },

            initChart() {
                const ctx = document.getElementById('progressChart');
                if (!ctx) return;
                
                if (this.chart) this.chart.destroy();
                
                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Completado', 'Pendiente'],
                        datasets: [{
                            data: [0, workshopData.steps.length],
                            backgroundColor: ['#6366f1', '#e2e8f0'],
                            borderWidth: 0,
                            cutout: '75%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } }
                    },
                    plugins: [{
                        id: 'textCenter',
                        beforeDraw: function(chart) {
                            var width = chart.width, height = chart.height, ctx = chart.ctx;
                            ctx.restore();
                            var fontSize = (height / 100).toFixed(2);
                            ctx.font = "bold " + fontSize + "em sans-serif";
                            ctx.textBaseline = "middle";
                            ctx.fillStyle = "#334155";
                            var text = Math.round((app.completedSteps.size / workshopData.steps.length) * 100) + "%",
                                textX = Math.round((width - ctx.measureText(text).width) / 2),
                                textY = height / 2;
                            ctx.fillText(text, textX, textY);
                            ctx.save();
                        }
                    }]
                });
            },

            updateChart() {
                if (!this.chart) return;
                const done = this.completedSteps.size;
                const total = workshopData.steps.length;
                this.chart.data.datasets[0].data = [done, total - done];
                this.chart.update();
            },

            copyToClipboard(btn) {
                const code = btn.parentElement.nextElementSibling.innerText;
                navigator.clipboard.writeText(code);
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copiado';
                btn.classList.add('text-emerald-400');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('text-emerald-400');
                }, 2000);
            },

            syntaxHighlight(code) {
                return code
                    .replace(/</g, "&lt;").replace(/>/g, "&gt;")
                    .replace(/(".+?")/g, '<span class="string">$1</span>')
                    .replace(/(#.+)/g, '<span class="comment">$1</span>')
                    .replace(/\b(def|class|from|import|return|yield|if|else|pass|@\w+)\b/g, '<span class="keyword">$1</span>')
                    .replace(/\b([a-zA-Z_]\w*)(?=\()/g, '<span class="function">$1</span>');
            }
        };

        // Iniciar
        app.init();
    </script>
</body>
</html>
